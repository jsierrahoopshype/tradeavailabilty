<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Trade Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 24px;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        h1 {
            font-size: 28px;
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* Discovery Section */
        .discovery-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .discovery-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #e74c3c;
        }
        
        .discovery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .discovery-card.blue { border-left-color: #1976d2; }
        .discovery-card.green { border-left-color: #27ae60; }
        .discovery-card.orange { border-left-color: #f39c12; }
        
        .discovery-card h3 {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .discovery-card .items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .discovery-tag {
            padding: 4px 10px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .discovery-tag:hover {
            background: #e74c3c;
            color: white;
        }
        
        .discovery-tag.blue:hover { background: #1976d2; }
        .discovery-tag.green:hover { background: #27ae60; }
        .discovery-tag.orange:hover { background: #f39c12; }
        
        /* Search Section */
        .search-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #playerSearch {
            width: 100%;
            padding: 14px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        #playerSearch:focus {
            border-color: #e74c3c;
        }
        
        #clearBtn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            display: none;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
            display: none;
        }
        
        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .autocomplete-item:hover {
            background: #f8f9fa;
        }
        
        .autocomplete-item .player-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .autocomplete-item .player-info {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        /* Selected Player Card */
        .selected-player {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }
        
        .selected-player.show { display: block; }
        
        .selected-player-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .selected-player h2 {
            font-size: 24px;
            margin-bottom: 4px;
            cursor: pointer;
        }
        
        .selected-player h2:hover {
            text-decoration: underline;
        }
        
        .selected-player .team-link {
            font-size: 14px;
            opacity: 0.9;
            cursor: pointer;
        }
        
        .selected-player .team-link:hover {
            text-decoration: underline;
        }
        
        .selected-player-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.15);
            padding: 12px 16px;
            border-radius: 8px;
        }
        
        .stat-box .label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }
        
        .stat-box .value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .trade-warning {
            background: rgba(255,255,255,0.2);
            padding: 10px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .share-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .share-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Results Section */
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .results-count {
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 6px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .filter-tab:hover, .filter-tab.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .filter-tab.perfect {
            border-color: #27ae60;
        }
        
        .filter-tab.perfect:hover, .filter-tab.perfect.active {
            background: #27ae60;
            border-color: #27ae60;
        }
        
        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            border-bottom: 2px solid #f0f0f0;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .results-table th:hover {
            color: #e74c3c;
        }
        
        .results-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .player-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .player-cell .name {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
        }
        
        .player-cell .name:hover {
            color: #e74c3c;
            text-decoration: underline;
        }
        
        .player-cell .contract-info {
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .team-cell {
            color: #1976d2;
            cursor: pointer;
            font-weight: 500;
        }
        
        .team-cell:hover {
            text-decoration: underline;
        }
        
        .salary-cell {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-badge.cap-space { background: #d4edda; color: #155724; }
        .status-badge.below-tax { background: #d1ecf1; color: #0c5460; }
        .status-badge.tax-team { background: #fff3cd; color: #856404; }
        .status-badge.first-apron { background: #f8d7da; color: #721c24; }
        .status-badge.second-apron { background: #721c24; color: white; }
        
        .fit-score {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .fit-bar {
            width: 60px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .fit-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .fit-bar-fill.high { background: #27ae60; }
        .fit-bar-fill.medium { background: #f39c12; }
        .fit-bar-fill.low { background: #e74c3c; }
        
        .cba-explainer {
            font-size: 11px;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 6px;
            border-left: 3px solid #1976d2;
        }
        
        .availability-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .availability-badge.available { background: #d4edda; color: #155724; }
        .availability-badge.restricted { background: #fff3cd; color: #856404; }
        .availability-badge.unavailable { background: #f8d7da; color: #721c24; }
        
        .perfect-match-badge {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        /* Team Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 20px;
        }
        
        .modal-header .team-status {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .roster-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .roster-player:hover {
            background: #f8f9fa;
        }
        
        .roster-player .name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .roster-player .salary {
            font-family: 'SF Mono', Monaco, monospace;
            color: #7f8c8d;
        }
        
        /* Empty/Loading States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* Leaderboard */
        .leaderboard-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .leaderboard-section h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .leaderboard-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .leaderboard-item:hover {
            background: #e74c3c;
            color: white;
        }
        
        .leaderboard-item .count {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .leaderboard-item:hover .count {
            background: white;
            color: #e74c3c;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #2c3e50;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            transition: transform 0.3s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .discovery-section {
                grid-template-columns: 1fr;
            }
            
            .results-table {
                display: block;
                overflow-x: auto;
            }
            
            .selected-player-header {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÄ NBA Trade Calculator</h1>
            <p class="subtitle">Find CBA-compliant salary matches for any player</p>
        </header>
        
        <!-- Discovery Section -->
        <div class="discovery-section">
            <div class="discovery-card" id="hotTargetsCard">
                <h3>üî• Hot Trade Targets</h3>
                <div class="items" id="hotTargets">
                    <span class="discovery-tag">Loading...</span>
                </div>
            </div>
            
            <div class="discovery-card blue" id="perfectMatchesCard">
                <h3>üíé Perfect Salary Matches</h3>
                <div class="items" id="perfectMatches">
                    <span class="discovery-tag blue">Loading...</span>
                </div>
            </div>
            
            <div class="discovery-card orange" id="capHellCard">
                <h3>üö® Cap Hell Teams</h3>
                <div class="items" id="capHellTeams">
                    <span class="discovery-tag orange">Loading...</span>
                </div>
            </div>
            
            <div class="discovery-card green" id="tradePicksCard">
                <h3>üéØ Trade Machine Picks</h3>
                <div class="items" id="tradePicks">
                    <span class="discovery-tag green">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="playerSearch" placeholder="Search for any player..." autocomplete="off">
                <button id="clearBtn">‚úï</button>
                <div class="autocomplete-list" id="autocomplete"></div>
            </div>
        </div>
        
        <!-- Selected Player Card -->
        <div class="selected-player" id="selectedPlayer">
            <div class="selected-player-header">
                <div>
                    <h2 id="selectedName"></h2>
                    <span class="team-link" id="selectedTeam"></span>
                </div>
                <button class="share-btn" id="shareBtn">üì§ Share Results</button>
            </div>
            <div class="selected-player-stats">
                <div class="stat-box">
                    <div class="label">Salary</div>
                    <div class="value" id="selectedSalary"></div>
                </div>
                <div class="stat-box">
                    <div class="label">Team Status</div>
                    <div class="value" id="selectedStatus"></div>
                </div>
                <div class="stat-box">
                    <div class="label">Cap Space</div>
                    <div class="value" id="selectedCapSpace"></div>
                </div>
                <div class="stat-box">
                    <div class="label">Trade Matches</div>
                    <div class="value" id="selectedMatches"></div>
                </div>
            </div>
            <div class="trade-warning" id="tradeWarning" style="display: none;">
                ‚ö†Ô∏è <span id="warningText"></span>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="results-title">Available Trade Targets</span>
                    <span class="results-count" id="resultsCount">0</span>
                </div>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">All</button>
                    <button class="filter-tab perfect" data-filter="perfect">üíé Perfect</button>
                    <button class="filter-tab" data-filter="available">‚úì Available</button>
                    <button class="filter-tab" data-filter="high-fit">High Fit</button>
                </div>
            </div>
            
            <table class="results-table">
                <thead>
                    <tr>
                        <th data-sort="player">Player ‚ñº</th>
                        <th data-sort="team">Team ‚ñº</th>
                        <th data-sort="salary">Salary ‚ñº</th>
                        <th data-sort="status">Status ‚ñº</th>
                        <th data-sort="fit">Fit ‚ñº</th>
                        <th>Availability</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="icon">üèÄ</div>
                                <div>Search for a player to see available trade options</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Leaderboard -->
        <div class="leaderboard-section">
            <h3>üìä Most Searched This Week</h3>
            <div class="leaderboard-items" id="leaderboard">
                <span style="color: #7f8c8d; font-size: 13px;">Start searching to build the leaderboard</span>
            </div>
        </div>
    </div>
    
    <!-- Team Modal -->
    <div class="modal-overlay" id="teamModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 id="modalTeamName"></h2>
                    <div class="team-status" id="modalTeamStatus"></div>
                </div>
                <button class="modal-close" id="modalClose">‚úï</button>
            </div>
            <div class="modal-body" id="modalRoster"></div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <script>
        // Configuration - Replace with your published Google Sheet CSV URL
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBC0OwPF_TMch0YgAbtFqYkwDWrsxRe7/pub?gid=0&single=true&output=csv';
        
        // State
        let allPlayers = [];
        let selectedPlayer = null;
        let currentResults = [];
        let sortColumn = 'salary';
        let sortDirection = 'desc';
        let activeFilter = 'all';
        
        // CBA Rules
        const CBA_RULES = {
            'Cap Space': { multiplier: 1, bonus: 0, usesCapSpace: true },
            'Below Tax': { multiplier: 1.75, bonus: 250000 },
            'Tax Team': { multiplier: 1.75, bonus: 250000 },
            '1st Apron': { multiplier: 1.10, bonus: 250000 },
            '2nd Apron': { multiplier: 1.00, bonus: 250000 }
        };
        
        // Leaderboard (localStorage)
        function getLeaderboard() {
            try {
                const data = localStorage.getItem('tradeCalcLeaderboard');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }
        
        function updateLeaderboard(playerName) {
            const lb = getLeaderboard();
            lb[playerName] = (lb[playerName] || 0) + 1;
            
            // Keep only top 20
            const sorted = Object.entries(lb)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            localStorage.setItem('tradeCalcLeaderboard', JSON.stringify(Object.fromEntries(sorted)));
            renderLeaderboard();
        }
        
        function renderLeaderboard() {
            const lb = getLeaderboard();
            const container = document.getElementById('leaderboard');
            
            const sorted = Object.entries(lb)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sorted.length === 0) {
                container.innerHTML = '<span style="color: #7f8c8d; font-size: 13px;">Start searching to build the leaderboard</span>';
                return;
            }
            
            container.innerHTML = sorted.map(([name, count]) => `
                <div class="leaderboard-item" onclick="searchPlayer('${name.replace(/'/g, "\\'")}')">
                    ${name}
                    <span class="count">${count}</span>
                </div>
            `).join('');
        }
        
        // Parse CSV
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).filter(line => line.trim()).map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (const char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = values[i] || '';
                });
                
                return obj;
            });
        }
        
        // Parse salary string to number
        function parseSalary(str) {
            if (!str) return 0;
            return parseInt(str.replace(/[$,]/g, '')) || 0;
        }
        
        // Format salary
        function formatSalary(num) {
            if (num >= 1000000) {
                return '$' + (num / 1000000).toFixed(1) + 'M';
            }
            return '$' + num.toLocaleString();
        }
        
        // Normalize column access (handles variations in column names)
        function getPlayer(p) { return p['PLAYER'] || p['Player'] || ''; }
        function getTeam(p) { return p['TEAM'] || p['Team'] || ''; }
        function getSalary(p) { return p['2026'] || p['Salary'] || ''; }
        function getStatus(p) { return p['TEAM STATUS'] || p['ST 25-26'] || p['Team Status'] || ''; }
        function getCapSpace(p) { return p['CAP SPACE'] || p['Cap Space'] || ''; }
        function getRating(p) { return parseFloat(p['RAT 365'] || p['Rating'] || '0') || 0; }
        function getNoTrade(p) { return p['NO TRADE'] || ''; }
        function getRestrictions(p) { return p['RESTRICTIONS'] || p['Availability'] || ''; }
        
        // Get team status class
        function getStatusClass(status) {
            const s = status.toUpperCase();
            if (s.includes('CAP SPACE')) return 'cap-space';
            if (s.includes('BELOW TAX')) return 'below-tax';
            if (s.includes('TAX TEAM') || s === 'TAX') return 'tax-team';
            if (s.includes('1ST') || s.includes('FIRST')) return 'first-apron';
            if (s.includes('2ND') || s.includes('SECOND')) return 'second-apron';
            return '';
        }
        
        // Normalize status for CBA rules lookup
        function normalizeStatus(status) {
            const s = status.toUpperCase();
            if (s.includes('CAP SPACE')) return 'Cap Space';
            if (s.includes('BELOW TAX')) return 'Below Tax';
            if (s.includes('TAX TEAM') || s === 'TAX') return 'Tax Team';
            if (s.includes('1ST') || s.includes('FIRST')) return '1st Apron';
            if (s.includes('2ND') || s.includes('SECOND')) return '2nd Apron';
            return status;
        }
        
        // Calculate max incoming salary
        function getMaxIncoming(player) {
            const status = normalizeStatus(getStatus(player));
            const rules = CBA_RULES[status];
            
            if (!rules) return 0;
            
            const outgoing = parseSalary(getSalary(player));
            
            if (rules.usesCapSpace) {
                const capSpace = parseSalary(getCapSpace(player));
                return outgoing + capSpace;
            }
            
            return outgoing * rules.multiplier + rules.bonus;
        }
        
        // Check if trade is legal (both directions)
        function canTrade(player1, player2) {
            const salary1 = parseSalary(getSalary(player1));
            const salary2 = parseSalary(getSalary(player2));
            
            // Skip players with no salary
            if (salary1 === 0 || salary2 === 0) return false;
            
            const max1CanReceive = getMaxIncoming(player1);
            const max2CanReceive = getMaxIncoming(player2);
            
            return salary2 <= max1CanReceive && salary1 <= max2CanReceive;
        }
        
        // Generate CBA explainer
        function getCBAExplainer(fromPlayer, toPlayer) {
            const fromSalary = parseSalary(getSalary(fromPlayer));
            const toSalary = parseSalary(getSalary(toPlayer));
            const toStatus = normalizeStatus(getStatus(toPlayer));
            const toTeam = getTeam(toPlayer);
            const rules = CBA_RULES[toStatus];
            
            if (!rules) return '';
            
            if (rules.usesCapSpace) {
                const capSpace = parseSalary(getCapSpace(toPlayer));
                return `${toTeam} can absorb using ${formatSalary(capSpace)} cap space + ${formatSalary(toSalary)} outgoing`;
            }
            
            const maxReceive = toSalary * rules.multiplier + rules.bonus;
            const percentage = Math.round(rules.multiplier * 100);
            return `${percentage}% of ${formatSalary(toSalary)} = ${formatSalary(maxReceive)} max incoming`;
        }
        
        // Calculate fit score (simple algorithm)
        function calculateFitScore(fromPlayer, toPlayer) {
            let score = 50;
            
            const salaryDiff = Math.abs(
                parseSalary(getSalary(fromPlayer)) - 
                parseSalary(getSalary(toPlayer))
            );
            
            // Closer salaries = better fit
            if (salaryDiff < 1000000) score += 30;
            else if (salaryDiff < 5000000) score += 20;
            else if (salaryDiff < 10000000) score += 10;
            
            // Available players get bonus (no restrictions)
            const restrictions = getRestrictions(toPlayer);
            if (!restrictions) score += 20;
            
            // Higher rated players get bonus
            const rating = getRating(toPlayer);
            if (rating >= 10) score += 10;
            else if (rating >= 5) score += 5;
            
            return Math.min(100, Math.max(0, score));
        }
        
        // Check if perfect salary match (within 5%)
        function isPerfectMatch(player1, player2) {
            const s1 = parseSalary(getSalary(player1));
            const s2 = parseSalary(getSalary(player2));
            if (s1 === 0 || s2 === 0) return false;
            const diff = Math.abs(s1 - s2);
            return diff / Math.max(s1, s2) < 0.05;
        }
        
        // Find trade matches for a player
        function findMatches(player) {
            const team = getTeam(player);
            
            return allPlayers
                .filter(p => getTeam(p) !== team)
                .filter(p => parseSalary(getSalary(p)) > 0) // Must have salary
                .filter(p => canTrade(player, p))
                .map(p => ({
                    ...p,
                    fitScore: calculateFitScore(player, p),
                    isPerfect: isPerfectMatch(player, p),
                    cbaExplainer: getCBAExplainer(player, p)
                }));
        }
        
        // Render results
        function renderResults(matches) {
            const tbody = document.getElementById('resultsBody');
            
            if (matches.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="icon">üòï</div>
                                <div>No matching trade targets found for this player</div>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('resultsCount').textContent = '0';
                return;
            }
            
            // Apply filter
            let filtered = matches;
            if (activeFilter === 'perfect') {
                filtered = matches.filter(m => m.isPerfect);
            } else if (activeFilter === 'available') {
                filtered = matches.filter(m => !getRestrictions(m) && !getNoTrade(m));
            } else if (activeFilter === 'high-fit') {
                filtered = matches.filter(m => m.fitScore >= 70);
            }
            
            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (sortColumn) {
                    case 'player':
                        aVal = getPlayer(a).toLowerCase();
                        bVal = getPlayer(b).toLowerCase();
                        break;
                    case 'team':
                        aVal = getTeam(a).toLowerCase();
                        bVal = getTeam(b).toLowerCase();
                        break;
                    case 'salary':
                        aVal = parseSalary(getSalary(a));
                        bVal = parseSalary(getSalary(b));
                        break;
                    case 'status':
                        aVal = getStatus(a).toLowerCase();
                        bVal = getStatus(b).toLowerCase();
                        break;
                    case 'fit':
                        aVal = a.fitScore;
                        bVal = b.fitScore;
                        break;
                    default:
                        aVal = parseSalary(getSalary(a));
                        bVal = parseSalary(getSalary(b));
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                }
                return aVal < bVal ? 1 : -1;
            });
            
            document.getElementById('resultsCount').textContent = filtered.length;
            
            tbody.innerHTML = filtered.map(p => {
                const name = getPlayer(p);
                const team = getTeam(p);
                const salary = parseSalary(getSalary(p));
                const status = getStatus(p);
                const restrictions = getRestrictions(p);
                const noTrade = getNoTrade(p);
                const rating = getRating(p);
                
                const fitLevel = p.fitScore >= 70 ? 'high' : p.fitScore >= 40 ? 'medium' : 'low';
                
                // Determine availability status
                let availText = 'Available';
                let availClass = 'available';
                if (noTrade === 'YES') {
                    availText = 'No-Trade Clause';
                    availClass = 'unavailable';
                } else if (restrictions) {
                    availText = `Until ${restrictions}`;
                    availClass = 'restricted';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="player-cell">
                                <span class="name" onclick="searchPlayer('${name.replace(/'/g, "\\'")}')">${name}</span>
                                ${p.isPerfect ? '<span class="perfect-match-badge">PERFECT MATCH</span>' : ''}
                                ${rating > 0 ? `<span class="contract-info">Rating: ${rating.toFixed(1)}</span>` : ''}
                            </div>
                            <div class="cba-explainer">${p.cbaExplainer}</div>
                        </td>
                        <td class="team-cell" onclick="showTeam('${team}')">${team}</td>
                        <td class="salary-cell">${formatSalary(salary)}</td>
                        <td><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                        <td>
                            <div class="fit-score">
                                <div class="fit-bar">
                                    <div class="fit-bar-fill ${fitLevel}" style="width: ${p.fitScore}%"></div>
                                </div>
                                <span>${p.fitScore}</span>
                            </div>
                        </td>
                        <td><span class="availability-badge ${availClass}">${availText}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Select player
        function selectPlayer(player) {
            selectedPlayer = player;
            
            const name = getPlayer(player);
            const team = getTeam(player);
            const salary = parseSalary(getSalary(player));
            const status = getStatus(player);
            const capSpace = parseSalary(getCapSpace(player));
            const restrictions = getRestrictions(player);
            const noTrade = getNoTrade(player);
            
            document.getElementById('selectedName').textContent = name;
            document.getElementById('selectedName').onclick = () => searchPlayer(name);
            document.getElementById('selectedTeam').textContent = team;
            document.getElementById('selectedTeam').onclick = () => showTeam(team);
            document.getElementById('selectedSalary').textContent = formatSalary(salary);
            document.getElementById('selectedStatus').textContent = status;
            document.getElementById('selectedCapSpace').textContent = normalizeStatus(status) === 'Cap Space' ? formatSalary(capSpace) : 'N/A';
            
            const matches = findMatches(player);
            currentResults = matches;
            
            document.getElementById('selectedMatches').textContent = matches.length;
            document.getElementById('selectedPlayer').classList.add('show');
            
            // Show warning if not available
            if (noTrade === 'YES') {
                document.getElementById('tradeWarning').style.display = 'flex';
                document.getElementById('warningText').textContent = 'This player has a no-trade clause';
            } else if (restrictions) {
                document.getElementById('tradeWarning').style.display = 'flex';
                document.getElementById('warningText').textContent = `This player cannot be traded until ${restrictions}`;
            } else {
                document.getElementById('tradeWarning').style.display = 'none';
            }
            
            renderResults(matches);
            updateLeaderboard(name);
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('player', name);
            window.history.pushState({}, '', url);
        }
        
        // Search for player by name
        function searchPlayer(name) {
            const player = allPlayers.find(p => 
                getPlayer(p).toLowerCase() === name.toLowerCase()
            );
            if (player) {
                document.getElementById('playerSearch').value = name;
                document.getElementById('clearBtn').style.display = 'block';
                document.getElementById('autocomplete').style.display = 'none';
                selectPlayer(player);
            }
        }
        
        // Show team modal
        function showTeam(teamName) {
            const roster = allPlayers.filter(p => 
                getTeam(p) === teamName
            ).filter(p => parseSalary(getSalary(p)) > 0)
            .sort((a, b) => {
                const s1 = parseSalary(getSalary(a));
                const s2 = parseSalary(getSalary(b));
                return s2 - s1;
            });
            
            if (roster.length === 0) return;
            
            const status = getStatus(roster[0]);
            const capSpace = parseSalary(getCapSpace(roster[0]));
            
            document.getElementById('modalTeamName').textContent = teamName;
            document.getElementById('modalTeamStatus').textContent = 
                `${status}${normalizeStatus(status) === 'Cap Space' ? ` ‚Ä¢ ${formatSalary(capSpace)} available` : ''}`;
            
            document.getElementById('modalRoster').innerHTML = roster.map(p => {
                const name = getPlayer(p);
                const salary = parseSalary(getSalary(p));
                const rating = getRating(p);
                return `
                    <div class="roster-player" onclick="closeModal(); searchPlayer('${name.replace(/'/g, "\\'")}')">
                        <span class="name">${name}</span>
                        <span class="salary">${formatSalary(salary)}${rating > 0 ? ` ‚Ä¢ ${rating.toFixed(1)}` : ''}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('teamModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('teamModal').classList.remove('show');
        }
        
        // Calculate discovery features
        function calculateDiscoveryFeatures() {
            // Filter to players with actual salaries
            const validPlayers = allPlayers.filter(p => parseSalary(getSalary(p)) > 0);
            
            // Hot Trade Targets (most possible trade partners)
            const tradeCounts = validPlayers.map(p => ({
                player: p,
                count: validPlayers.filter(other => 
                    getTeam(other) !== getTeam(p) && 
                    canTrade(p, other)
                ).length
            })).sort((a, b) => b.count - a.count);
            
            const hotTargets = tradeCounts.slice(0, 6).map(t => ({
                name: getPlayer(t.player),
                count: t.count
            }));
            
            document.getElementById('hotTargets').innerHTML = hotTargets.map(h => 
                `<span class="discovery-tag" onclick="searchPlayer('${h.name.replace(/'/g, "\\'")}')">${h.name} (${h.count})</span>`
            ).join('');
            
            // Perfect Salary Matches
            const perfectPairs = [];
            for (let i = 0; i < validPlayers.length; i++) {
                for (let j = i + 1; j < validPlayers.length; j++) {
                    if (getTeam(validPlayers[i]) !== getTeam(validPlayers[j])) {
                        if (isPerfectMatch(validPlayers[i], validPlayers[j]) && canTrade(validPlayers[i], validPlayers[j])) {
                            perfectPairs.push({
                                p1: getPlayer(validPlayers[i]),
                                p2: getPlayer(validPlayers[j]),
                                salary: parseSalary(getSalary(validPlayers[i]))
                            });
                        }
                    }
                }
            }
            
            perfectPairs.sort((a, b) => b.salary - a.salary);
            const topPerfect = perfectPairs.slice(0, 4);
            
            document.getElementById('perfectMatches').innerHTML = topPerfect.map(p => 
                `<span class="discovery-tag blue" onclick="searchPlayer('${p.p1.replace(/'/g, "\\'")}')">${p.p1} ‚Üî ${p.p2}</span>`
            ).join('') || '<span class="discovery-tag blue">None found</span>';
            
            // Cap Hell Teams (2nd Apron)
            const capHellTeams = [...new Set(
                validPlayers
                    .filter(p => normalizeStatus(getStatus(p)) === '2nd Apron')
                    .map(p => getTeam(p))
            )];
            
            document.getElementById('capHellTeams').innerHTML = capHellTeams.slice(0, 6).map(t => 
                `<span class="discovery-tag orange" onclick="showTeam('${t}')">${t}</span>`
            ).join('') || '<span class="discovery-tag orange">None</span>';
            
            // Trade Machine Picks (balanced 2-player swaps with similar salaries)
            const tradePicks = perfectPairs
                .filter(p => p.salary > 10000000) // Only notable salaries
                .slice(0, 4);
            
            document.getElementById('tradePicks').innerHTML = tradePicks.map(p => 
                `<span class="discovery-tag green" onclick="searchPlayer('${p.p1.replace(/'/g, "\\'")}')">${p.p1} for ${p.p2}</span>`
            ).join('') || '<span class="discovery-tag green">Calculating...</span>';
        }
        
        // Share functionality
        function shareResults() {
            if (!selectedPlayer) return;
            
            const name = selectedPlayer['PLAYER'] || selectedPlayer['Player'];
            const url = `${window.location.origin}${window.location.pathname}?player=${encodeURIComponent(name)}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `NBA Trade Calculator - ${name}`,
                    text: `Found ${currentResults.length} trade matches for ${name}`,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url);
                showToast('Link copied to clipboard!');
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Initialize
        async function init() {
            try {
                // For demo, use sample data if CSV fails
                try {
                    const response = await fetch(CSV_URL);
                    const csv = await response.text();
                    allPlayers = parseCSV(csv);
                } catch (e) {
                    console.log('Using sample data');
                    // Sample data for testing
                    allPlayers = generateSampleData();
                }
                
                calculateDiscoveryFeatures();
                renderLeaderboard();
                
                // Check URL for player param
                const urlParams = new URLSearchParams(window.location.search);
                const playerParam = urlParams.get('player');
                if (playerParam) {
                    searchPlayer(playerParam);
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Sample data generator for testing
        function generateSampleData() {
            const teams = [
                { name: 'Lakers', status: '1st Apron' },
                { name: 'Celtics', status: 'Tax Team' },
                { name: 'Warriors', status: '2nd Apron' },
                { name: 'Heat', status: 'Below Tax' },
                { name: 'Nuggets', status: 'Tax Team' },
                { name: 'Bucks', status: '1st Apron' },
                { name: 'Suns', status: '2nd Apron' },
                { name: 'Thunder', status: 'Cap Space', capSpace: 15000000 },
                { name: 'Spurs', status: 'Cap Space', capSpace: 30000000 },
                { name: 'Pistons', status: 'Cap Space', capSpace: 25000000 }
            ];
            
            const players = [
                { name: 'LeBron James', team: 'Lakers', salary: 47607350 },
                { name: 'Anthony Davis', team: 'Lakers', salary: 43219440 },
                { name: 'Austin Reaves', team: 'Lakers', salary: 12016854 },
                { name: 'Jayson Tatum', team: 'Celtics', salary: 34848340 },
                { name: 'Jaylen Brown', team: 'Celtics', salary: 49205800 },
                { name: 'Stephen Curry', team: 'Warriors', salary: 55761216 },
                { name: 'Draymond Green', team: 'Warriors', salary: 22300000 },
                { name: 'Jimmy Butler', team: 'Heat', salary: 48798677 },
                { name: 'Bam Adebayo', team: 'Heat', salary: 34848340 },
                { name: 'Nikola Jokic', team: 'Nuggets', salary: 51415938 },
                { name: 'Jamal Murray', team: 'Nuggets', salary: 33833400 },
                { name: 'Giannis Antetokounmpo', team: 'Bucks', salary: 48787676 },
                { name: 'Damian Lillard', team: 'Bucks', salary: 45640084 },
                { name: 'Kevin Durant', team: 'Suns', salary: 51179021 },
                { name: 'Devin Booker', team: 'Suns', salary: 36016200 },
                { name: 'Bradley Beal', team: 'Suns', salary: 46741590 },
                { name: 'Shai Gilgeous-Alexander', team: 'Thunder', salary: 35000000 },
                { name: 'Chet Holmgren', team: 'Thunder', salary: 10875720 },
                { name: 'Victor Wembanyama', team: 'Spurs', salary: 12200880 },
                { name: 'Cade Cunningham', team: 'Pistons', salary: 10050120 }
            ];
            
            return players.map(p => {
                const teamInfo = teams.find(t => t.name === p.team);
                return {
                    'PLAYER': p.name,
                    'TEAM': p.team,
                    '2026': '$' + p.salary.toLocaleString(),
                    'ST 25-26': teamInfo.status,
                    'Cap Space': teamInfo.capSpace ? '$' + teamInfo.capSpace.toLocaleString() : '',
                    'Availability': 'Available'
                };
            });
        }
        
        // Event Listeners
        document.getElementById('playerSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            const autocomplete = document.getElementById('autocomplete');
            const clearBtn = document.getElementById('clearBtn');
            
            clearBtn.style.display = query ? 'block' : 'none';
            
            if (query.length < 2) {
                autocomplete.style.display = 'none';
                return;
            }
            
            const matches = allPlayers.filter(p => 
                getPlayer(p).toLowerCase().includes(query) && parseSalary(getSalary(p)) > 0
            ).slice(0, 8);
            
            if (matches.length === 0) {
                autocomplete.style.display = 'none';
                return;
            }
            
            autocomplete.innerHTML = matches.map(p => {
                const name = getPlayer(p);
                const team = getTeam(p);
                const salary = parseSalary(getSalary(p));
                return `
                    <div class="autocomplete-item" onclick="selectPlayer(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                        <span class="player-name">${name}</span>
                        <span class="player-info">${team} ‚Ä¢ ${formatSalary(salary)}</span>
                    </div>
                `;
            }).join('');
            
            autocomplete.style.display = 'block';
        });
        
        document.getElementById('clearBtn').addEventListener('click', function() {
            document.getElementById('playerSearch').value = '';
            document.getElementById('autocomplete').style.display = 'none';
            this.style.display = 'none';
            document.getElementById('selectedPlayer').classList.remove('show');
            selectedPlayer = null;
            currentResults = [];
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <div class="icon">üèÄ</div>
                            <div>Search for a player to see available trade options</div>
                        </div>
                    </td>
                </tr>
            `;
            
            const url = new URL(window.location);
            url.searchParams.delete('player');
            window.history.pushState({}, '', url);
        });
        
        // Close autocomplete on click outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('autocomplete').style.display = 'none';
            }
        });
        
        // Sort handlers
        document.querySelectorAll('.results-table th[data-sort]').forEach(th => {
            th.addEventListener('click', function() {
                const col = this.dataset.sort;
                if (sortColumn === col) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = col;
                    sortDirection = 'desc';
                }
                renderResults(currentResults);
            });
        });
        
        // Filter handlers
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                activeFilter = this.dataset.filter;
                renderResults(currentResults);
            });
        });
        
        // Modal close
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('teamModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Share button
        document.getElementById('shareBtn').addEventListener('click', shareResults);
        
        // Initialize on load
        init();
    </script>
</body>
</html>
